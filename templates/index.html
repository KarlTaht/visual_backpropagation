<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>{{ title }}</h1>
            <p class="subtitle">Real-time Neural Network Visualization</p>
        </header>

        <div class="content-card">
            <h2>Training Progress</h2>

            <!-- Training Controls -->
            <div style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- Epoch Training Control -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 0.9em;">Train N Epochs:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="epoch-count-input" value="1" min="1" max="100"
                                   style="flex: 1; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                            <button onclick="trainNEpochs()" style="padding: 8px 16px;">Go!</button>
                        </div>
                    </div>

                    <!-- Learning Rate Control -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 0.9em;">Learning Rate:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="learning-rate-input" step="0.0001" min="0.0001" max="1"
                                   style="flex: 1; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                            <button onclick="updateLearningRate()" style="padding: 8px 16px;">Update</button>
                        </div>
                        <div id="current-lr-display" style="font-size: 0.85em; color: #9ca3af; margin-top: 3px;"></div>
                    </div>

                    <!-- Batch Size Control -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 0.9em;">Batch Size:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="batch-size-input" min="1" max="1000"
                                   style="flex: 1; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                            <button onclick="updateBatchSize()" style="padding: 8px 16px;">Update</button>
                        </div>
                        <div id="current-batch-size-display" style="font-size: 0.85em; color: #9ca3af; margin-top: 3px;"></div>
                    </div>

                    <!-- Loss Type Control -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 0.9em;">Loss Function:</label>
                        <div style="display: flex; gap: 15px; align-items: center; padding: 8px 0;">
                            <label style="color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="loss-type" value="mse" onchange="updateLossType('mse')" style="margin-right: 5px;">
                                MSE
                            </label>
                            <label style="color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="loss-type" value="cross_entropy" onchange="updateLossType('cross_entropy')" style="margin-right: 5px;">
                                Cross-Entropy
                            </label>
                        </div>
                        <div id="current-loss-type-display" style="font-size: 0.85em; color: #9ca3af;"></div>
                    </div>
                </div>
            </div>

            <!-- Training Run Management -->
            <div style="margin-bottom: 20px; padding: 15px; background: #1e3a5f; border-radius: 8px; border-left: 4px solid #60a5fa;">
                <h3 style="margin: 0 0 15px 0; color: #93c5fd; font-size: 1.1em;">Training Runs</h3>

                <!-- Create New Run -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <input type="text" id="new-run-name" placeholder="Run name (optional)"
                           style="flex: 1; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px; max-width: 250px;">
                    <button onclick="createRun()" style="padding: 8px 16px; background: #2563eb; border-color: #2563eb;">
                        + New Run
                    </button>
                    <button onclick="loadRuns()" style="padding: 8px 12px; background: #4b5563; border-color: #4b5563;">
                        Refresh
                    </button>
                </div>

                <!-- Active Run Info -->
                <div id="active-run-info" style="margin-bottom: 10px; padding: 10px; background: #0f172a; border-radius: 6px;">
                    <span style="color: #9ca3af;">No active run</span>
                </div>

                <!-- Run List -->
                <div id="run-list" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #9ca3af;">Loading runs...</p>
                </div>
            </div>

            <div id="training-stats">
                <p>Loading training statistics...</p>
            </div>

            <!-- Persistent chart container -->
            <div id="loss-chart" style="width: 100%; height: 400px; margin-top: 20px;"></div>

            <!-- Gradient Norms Chart -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 10px; color: #2d3748;">Gradient Norms Over Training Steps</h3>
                <div id="gradient-norms-chart" style="width: 100%; height: 300px;">
                    <p style="color: #9ca3af;">Gradient norm tracking will appear here after training steps.</p>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="runEpoch()">Run Single Epoch</button>
                <button onclick="runSingleStep()">Run Single Step</button>
                <button onclick="resetTraining()">Reset Training</button>
                <button onclick="resetModel()" style="background: #dc2626; border-color: #dc2626;">Reset Model</button>
                <button onclick="loadTrainingStats()">Refresh Stats</button>
            </div>
        </div>

        <div class="content-card">
            <div class="status">
                <div class="status-indicator"></div>
                <span><strong>Server Status:</strong> Connected</span>
            </div>

            <h2>Model Architecture</h2>
            <div id="model-info">
                <p>Loading model information...</p>
            </div>
        </div>

        <div class="content-card">
            <h2>Training Data</h2>
            <div id="dataset-info">
                <p>Loading dataset information...</p>
            </div>
        </div>

        <!-- Distribution Analysis Section (New Feature) -->
        <div class="content-card">
            <h2>Distribution Analysis</h2>
            <p style="color: #9ca3af; margin-bottom: 15px;">Analyze weight and gradient distributions across layers.</p>

            <div style="margin-bottom: 15px;">
                <button onclick="Distributions.loadStats()">Refresh Distributions</button>
            </div>

            <!-- Layer Statistics Summary -->
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 10px; color: #2d3748;">Layer Statistics Summary</h3>
                <div id="layer-stats-summary">
                    <p style="color: #9ca3af;">Click "Refresh Distributions" to load data.</p>
                </div>
            </div>

            <!-- Column Headers -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                <div style="text-align: center; padding: 10px; background: #1e3a1e; border-radius: 8px;">
                    <h3 style="margin: 0; color: #4ade80; font-size: 1.1em;">Weight Distributions →</h3>
                </div>
                <div style="text-align: center; padding: 10px; background: #3a1e1e; border-radius: 8px;">
                    <h3 style="margin: 0; color: #fb923c; font-size: 1.1em;">← Gradient Distributions</h3>
                </div>
            </div>

            <!-- Two-column distribution layout -->
            <div id="distributions-container" style="margin-bottom: 20px;">
                <p style="color: #9ca3af; text-align: center; padding: 40px;">Click "Refresh Distributions" to load data.</p>
            </div>

        </div>

        <div class="content-card">
            <h2>Master Sequence Testing</h2>
            <p style="color: #9ca3af; margin-bottom: 15px;">Test the model's performance on the master sequences used to generate training data.</p>

            <div style="margin-bottom: 15px;">
                <button onclick="testMasterSequences()">Test Master Sequences</button>
            </div>

            <div id="master-sequence-results">
                <p style="color: #9ca3af;">Click "Test Master Sequences" to evaluate model performance.</p>
            </div>
        </div>

        <div class="content-card">
            <h2>Network Visualization</h2>

            <div style="margin-bottom: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                <label style="font-weight: 600; color: #2d3748; margin-right: 15px;">Mode:</label>
                <label style="color: #2d3748; cursor: pointer; margin-right: 15px;">
                    <input type="radio" name="viz-mode" value="visualize" checked style="margin-right: 5px;">
                    Visualize Only (no weight updates)
                </label>
                <label style="color: #2d3748; cursor: pointer;">
                    <input type="radio" name="viz-mode" value="train" style="margin-right: 5px;">
                    Train (update weights)
                </label>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <button onclick="runSingleStep()">Run Single Step</button>
                <button onclick="runBatch()">Run Batch</button>
                <button onclick="runEpoch()">Run Full Epoch</button>
                <button onclick="loadModelState()">Refresh Model State</button>
            </div>

            <!-- Column Headers -->
            <div class="network-grid" style="margin-top: 20px;">
                <div class="column-header forward-column">Forward Pass →</div>
                <div class="column-header backward-column">← Backward Pass</div>
            </div>

            <!-- Input/Output Display -->
            <div class="io-container" id="io-display" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #2d3748;">Current Example</h3>
                <div class="io-grid">
                    <!-- Forward Pass Side -->
                    <div class="io-section">
                        <h4>Forward Pass - Sequence View</h4>
                        <div id="forward-io">
                            <p style="color: #718096;">Run a forward pass to see data</p>
                        </div>
                    </div>

                    <!-- Backward Pass Side -->
                    <div class="io-section">
                        <h4>Backward Pass - Vector View</h4>
                        <div id="backward-io">
                            <p style="color: #718096;">Run a forward pass to see data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Color Scale Legend -->
            <div id="color-scale-legend"></div>

            <!-- Network Layers -->
            <div id="network-visualization">
                <p style="color: #718096;">Loading network layers...</p>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules in dependency order -->
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/heatmaps.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/display.js') }}"></script>
    <script src="{{ url_for('static', filename='js/controls.js') }}"></script>
    <script src="{{ url_for('static', filename='js/runs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/distributions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
